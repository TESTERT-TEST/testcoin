name: Build Verus CLI

on:
  push:
    branches: [main, master, release/*]
  pull_request:
    branches: [master]

env:
  VERSION: 1.2.12-2
  STRIP_BINARIES: "false"

jobs:
  # Linux x86_64 build
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: asherd/verus-builders:verus-debian-10
    env:
      CONFIGURE_FLAGS: --with-gcc-arch=x86-64
      VERUS_CLI_LINUX_X86_64: Verus-CLI-Linux-v${{ env.VERSION }}-x86_64.tar.gz
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Verus CLI
      run: |
        zcutil/build.sh -j$(nproc)
        
    - name: Strip binaries if enabled
      if: env.STRIP_BINARIES == 'true'
      run: |
        strip --strip-unneeded src/verus
        strip --strip-unneeded src/verusd
        
    - name: Package binaries
      run: |
        mkdir verus-cli
        cp src/verus \
          src/verusd \
          doc/man/verus-cli/linux/README.txt \
          zcutil/fetch-params.sh \
          vcutil/fetch-bootstrap.sh \
          verus-cli/
        mv verus-cli/fetch-params.sh verus-cli/fetch-params
        mv verus-cli/fetch-bootstrap.sh verus-cli/fetch-bootstrap
        chmod +x verus-cli/verus
        chmod +x verus-cli/verusd
        chmod +x verus-cli/fetch-params
        chmod +x verus-cli/fetch-bootstrap
        tar -czvf ${{ env.VERUS_CLI_LINUX_X86_64 }} verus-cli
        
    - name: Generate SHA256 checksum
      run: |
        sha256sum ${{ env.VERUS_CLI_LINUX_X86_64 }} > ${{ env.VERUS_CLI_LINUX_X86_64 }}.sha256
        
    - name: Upload Linux x86_64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-cli-linux-x86_64
        path: |
          ${{ env.VERUS_CLI_LINUX_X86_64 }}
          ${{ env.VERUS_CLI_LINUX_X86_64 }}.sha256
        retention-days: 7

  # Linux ARM64 build
  build-linux-arm64:
    runs-on: ubuntu-latest
    container:
      image: asherd/verus-builders:cross-arm
    env:
      HOST: aarch64-linux-gnu
      STRIP: /usr/aarch64-linux-gnu/bin/strip
      VERUS_CLI_ARM64_LINUX: Verus-CLI-Linux-v${{ env.VERSION }}-arm64.tar.gz
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Verus CLI for ARM64
      run: |
        zcutil/build.sh -j$(nproc)
        
    - name: Strip binaries if enabled
      if: env.STRIP_BINARIES == 'true'
      run: |
        /usr/aarch64-linux-gnu/bin/strip --strip-unneeded src/verus
        /usr/aarch64-linux-gnu/bin/strip --strip-unneeded src/verusd
        
    - name: Package ARM64 binaries
      run: |
        mkdir verus-cli
        cp src/verus \
          src/verusd \
          doc/man/verus-cli/linux/README.txt \
          zcutil/fetch-params.sh \
          vcutil/fetch-bootstrap.sh \
          verus-cli/
        mv verus-cli/fetch-params.sh verus-cli/fetch-params
        mv verus-cli/fetch-bootstrap.sh verus-cli/fetch-bootstrap
        chmod +x verus-cli/verus
        chmod +x verus-cli/verusd
        chmod +x verus-cli/fetch-params
        chmod +x verus-cli/fetch-bootstrap
        tar -czvf ${{ env.VERUS_CLI_ARM64_LINUX }} verus-cli
        
    - name: Generate SHA256 checksum
      run: |
        sha256sum ${{ env.VERUS_CLI_ARM64_LINUX }} > ${{ env.VERUS_CLI_ARM64_LINUX }}.sha256
        
    - name: Upload Linux ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-cli-linux-arm64
        path: |
          ${{ env.VERUS_CLI_ARM64_LINUX }}
          ${{ env.VERUS_CLI_ARM64_LINUX }}.sha256
        retention-days: 7

  # Windows build
  build-windows:
    runs-on: ubuntu-latest
    container:
      image: asherd/verus-builders:verus-windows
    env:
      CONFIGURE_FLAGS: --with-gcc-arch=x86-64
      VERUS_CLI_WINDOWS: Verus-CLI-Windows-v${{ env.VERSION }}.zip
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Verus CLI for Windows
      run: |
        zcutil/build-win.sh -j$(nproc)
        
    - name: Package Windows binaries
      run: |
        mkdir verus-cli
        cp src/verus.exe \
          src/verusd.exe \
          doc/man/verus-cli/windows/README.txt \
          zcutil/fetch-params.bat \
          vcutil/fetch-bootstrap.bat \
          verus-cli/
          
    - name: Strip binaries if enabled
      if: env.STRIP_BINARIES == 'true'
      run: |
        strip --strip-unneeded verus-cli/verusd.exe
        strip --strip-unneeded verus-cli/verus.exe
        
    - name: Create Windows ZIP
      run: |
        zip -r ${{ env.VERUS_CLI_WINDOWS }} verus-cli
        
    - name: Generate SHA256 checksum
      run: |
        sha256sum ${{ env.VERUS_CLI_WINDOWS }} > ${{ env.VERUS_CLI_WINDOWS }}.sha256
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-cli-windows
        path: |
          ${{ env.VERUS_CLI_WINDOWS }}
          ${{ env.VERUS_CLI_WINDOWS }}.sha256
        retention-days: 7

  # macOS build
  build-macos:
    runs-on: macos-latest
    env:
      CONFIGURE_FLAGS: --with-gcc-arch=x86-64
      VERUS_CLI_MACOS: Verus-CLI-MacOS-v${{ env.VERSION }}.tar.gz
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Verus CLI for macOS
      run: |
        zcutil/build-mac.sh -j$(sysctl -n hw.physicalcpu)
        
    - name: Package macOS binaries
      run: |
        mkdir verus-cli
        cp src/verus \
          src/verusd \
          doc/man/verus-cli/mac/README.txt \
          zcutil/fetch-params.sh \
          vcutil/fetch-bootstrap.sh \
          verus-cli/
        mv verus-cli/fetch-params.sh verus-cli/fetch-params
        mv verus-cli/fetch-bootstrap.sh verus-cli/fetch-bootstrap
        chmod +x verus-cli/fetch-params
        chmod +x verus-cli/fetch-bootstrap
        chmod +x verus-cli/verus
        chmod +x verus-cli/verusd
        tar -czvf ${{ env.VERUS_CLI_MACOS }} verus-cli
        
    - name: Generate SHA256 checksum
      run: |
        shasum -a 256 ${{ env.VERUS_CLI_MACOS }} > ${{ env.VERUS_CLI_MACOS }}.sha256
        
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-cli-macos
        path: |
          ${{ env.VERUS_CLI_MACOS }}
          ${{ env.VERUS_CLI_MACOS }}.sha256
        retention-days: 7

  # Deploy stage
  deploy:
    runs-on: ubuntu-latest
    needs: [build-linux, build-linux-arm64, build-windows, build-macos]
    env:
      VERUS_CLI_LINUX_X86_64: Verus-CLI-Linux-v${{ env.VERSION }}-x86_64.tar.gz
      VERUS_CLI_ARM64_LINUX: Verus-CLI-Linux-v${{ env.VERSION }}-arm64.tar.gz
      VERUS_CLI_WINDOWS: Verus-CLI-Windows-v${{ env.VERSION }}.zip
      VERUS_CLI_MACOS: Verus-CLI-MacOS-v${{ env.VERSION }}.tar.gz
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create release structure
      run: |
        mkdir -p release/Windows release/Linux release/MacOS
        # Copy Windows artifacts
        cp verus-cli-windows/${{ env.VERUS_CLI_WINDOWS }} release/Windows/
        cp verus-cli-windows/${{ env.VERUS_CLI_WINDOWS }}.sha256 release/Windows/
        # Copy Linux artifacts
        cp verus-cli-linux-x86_64/${{ env.VERUS_CLI_LINUX_X86_64 }} release/Linux/
        cp verus-cli-linux-x86_64/${{ env.VERUS_CLI_LINUX_X86_64 }}.sha256 release/Linux/
        cp verus-cli-linux-arm64/${{ env.VERUS_CLI_ARM64_LINUX }} release/Linux/
        cp verus-cli-linux-arm64/${{ env.VERUS_CLI_ARM64_LINUX }}.sha256 release/Linux/
        # Copy macOS artifacts
        cp verus-cli-macos/${{ env.VERUS_CLI_MACOS }} release/MacOS/
        cp verus-cli-macos/${{ env.VERUS_CLI_MACOS }}.sha256 release/MacOS/
        
    - name: List release files
      run: |
        find release -type f -name "*.sha256" -exec echo "=== {} ===" \; -exec cat {} \;
        
    - name: Upload final release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-cli-release
        path: release/
        retention-days: 7
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/Windows/*
          release/Linux/*
          release/MacOS/*
